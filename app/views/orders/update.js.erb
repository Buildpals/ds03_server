<% if Rails.env.development? || Rails.env.test? %>
const publicKey = "FLWPUBK_TEST-5d111ed01ffb9d0a9b6a0d0811ceb591-X";
<% else %>
const publicKey = "FLWPUBK-8289a3561ffe0c40c4904e20d550db77-X";
<% end %>
var txref = "Order<%= @order.id %>_" + Math.random().toString().split('.')[1];

payWithRave()

function payWithRave() {
    var reference = txref;
    var price = parseInt("<%= dollar_to_cedi @order.order_total %>");
    var x = getpaidSetup({
        PBFPubKey: publicKey,
        customer_email: "<%= escape_javascript @order.email %>",
        amount: price,
        customer_phone: "<%= escape_javascript @order.phone_number %>",
        currency: "GHS",
        country: 'GH',
        payment_options: "mobilemoneyghana,card",
        txref: txref,
        meta: [{
            order_id: "<%= @order.id %>",
            link_to_order: "<%= order_url @order %>",
            title: "<%= escape_javascript @order.product.title %>",
            item_url: "<%= escape_javascript @order.product.item_url %>",
            price: "<%= escape_javascript number_to_currency @order.price %>",
            quantity: "<%= escape_javascript @order.quantity %>",
            subtotal: "<%= escape_javascript number_to_currency @order.subtotal %>",
            delivery_method: "<%= escape_javascript @order.delivery_method&.titleize %>",
            delivery_region: "<%= escape_javascript @order.region&.titleize %>",
            shipping_and_handling: "<%= escape_javascript number_to_currency @order.price %>",
            total_cost: "<%= escape_javascript number_to_currency @order.order_total %>",
            full_name: "<%= escape_javascript @order.full_name %>",
            email: "<%= escape_javascript @order.email %>",
            phone_number: "<%= escape_javascript @order.phone_number %>"
        }],
        onclose: function () {
        },
        callback: function (response) {
            var txref = response.tx.txRef; // collect txRef returned and pass to a server page to complete status check.
            console.log("This is the response returned after a charge", response);
            if (
                response.tx.chargeResponseCode == "00" ||
                response.tx.chargeResponseCode == "0"
            ) {
                $('#order_form').formTarget.submit()

                //show success modal
                window.location.href = '/payment?' + 'txRef='
                    + reference
                    + '&order_id=' + "<%= @order.id %>"
                    + '&product_id=' + "<%= @order.product.id %>"
                    + '&email=' + "<%= escape_javascript @order.email %>"
                    + '&phone_number=' + "<%= escape_javascript @order.phone_number %>"
                    + '&name=' + "<%= escape_javascript @order.full_name %>" + '';
            } else {
                // show failure modal
            }

            x.close();
        }
    });
}